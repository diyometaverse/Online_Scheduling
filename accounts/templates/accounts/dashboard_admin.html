<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Admin Dashboard - Kurumi Studio</title>
<link href="https://fonts.googleapis.com/css2?family=Great+Vibes&family=Montserrat:wght@300;400;600&display=swap" rel="stylesheet">

<!-- FULLCALENDAR CDN -->
<link href="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.10/index.global.min.css" rel="stylesheet">
<script src="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.10/index.global.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/@popperjs/core@2"></script>

<style>
:root{
    --bg:#0f0710;
    --card:#1e1320;
    --accent:#c43b8d;
    --muted:#bba6bf;
}
body{
    margin:0;
    background:linear-gradient(180deg,var(--bg),#07020a);
    color:var(--muted);
    font-family:Montserrat, sans-serif;
}
.admin-container{
    max-width:1300px;
    margin:60px auto;
    padding:20px;
}

/* ===================== NAVIGATION ===================== */
.admin-nav {
    margin-bottom: 30px;
}
.admin-nav ul {
    display: flex;
    gap: 20px;
    list-style: none;
    padding: 0;
}
.admin-nav ul li a {
    color: var(--muted);
    font-weight: 500;
    text-decoration: none;
    padding: 8px 16px;
    border-radius: 10px;
    transition: all 0.3s ease;
}
.admin-nav ul li a:hover {
    background: rgba(196, 59, 141, 0.2);
    color: white;
}
.admin-nav ul li a.active {
    background: linear-gradient(90deg, #c43b8d, #8d2a62);
    color: white;
    font-weight: 700;
    box-shadow: 0 4px 15px rgba(196, 59, 141, 0.4);
}

/* ===================== SECTION & CARDS ===================== */
.section-title{
    font-family:'Great Vibes', cursive;
    color:var(--accent);
    font-size:34px;
    text-align:center;
    margin-bottom:30px;
}
.card{
    background:rgba(35,10,35,0.7);
    padding:25px;
    border-radius:20px;
    border:1px solid rgba(196,59,141,0.4);
    box-shadow:0 0 25px rgba(196,59,141,0.2);
    margin-bottom:30px;
}
.summary-grid{
    display:grid;
    grid-template-columns:repeat(auto-fit,minmax(220px,1fr));
    gap:20px;
}
.summary-box{
    background:rgba(50,20,55,0.6);
    padding:20px;
    border-radius:18px;
    border:1px solid rgba(255,255,255,0.05);
    text-align:center;
}
.summary-box h2{ color:white; font-size:32px; margin:0; }
.summary-box p{ color:var(--muted); font-size:14px; }

.table-card{ padding:25px; }
table{ width:100%; border-collapse:collapse; }
th, td{ padding:14px; border-bottom:1px solid rgba(255,255,255,.08); }
th{ color:white; }

.action-btn{
    padding:8px 14px;
    border-radius:10px;
    text-decoration:none;
    color:white;
    font-weight:600;
    display:inline-block;
    margin-right:6px;
}
.approve{ background:linear-gradient(90deg,#4CAF50,#2e7d32); }
.deny{ background:linear-gradient(90deg,#e53935,#8e0000); }
.edit{ background:linear-gradient(90deg,#3f51b5,#1a237e); }
.resched{ background:linear-gradient(90deg,#ff9800,#e65100); }
.user-del{ background:linear-gradient(90deg,#9c27b0,#6a0080); }

.admin-grid{
    display:grid;
    grid-template-columns:2fr 1fr;
    gap:30px;
}

/* MODAL */
#bookingModal {
    display:none;
    position:fixed;
    top:0; left:0;
    width:100%; height:100%;
    background:rgba(0,0,0,0.7);
    z-index:2000;
    justify-content:center;
    align-items:center;
}
.modal-box {
    background:var(--card);
    padding:25px;
    width:380px;
    border-radius:15px;
    border:1px solid var(--accent);
    color:white;
}
.close-modal {
    float:right;
    cursor:pointer;
    font-size:20px;
    color:#ccc;
}

/* COLORS FOR STATUSES */
.event-approved { background:#4caf50 !important; border:none !important; }
.event-pending { background:#ffeb3b !important; color:black !important; border:none !important; }
.event-cancelled { background:#e53935 !important; border:none !important; }
.event-denied { background:#757575 !important; border:none !important; }
</style>
</head>

<body>

<div class="admin-container">

    <!-- NAVIGATION -->
    <nav class="admin-nav">
        <ul>
            <li><a href="{% url 'home' %}" class="{% if request.resolver_match.url_name == 'home' %}active{% endif %}">Home</a></li>
            <li><a href="{% url 'create_booking' %}" class="{% if request.resolver_match.url_name == 'create_booking' %}active{% endif %}">Book Session</a></li>
            <li><a href="{% url 'my_bookings' %}" class="{% if request.resolver_match.url_name == 'my_bookings' %}active{% endif %}">My Bookings</a></li>
            <li><a href="{% url 'about' %}" class="{% if request.resolver_match.url_name == 'about' %}active{% endif %}">About</a></li>
            <li><a href="#" onclick="showConfirmModal('Logout','Are you sure you want to logout?', '{% url 'logout' %}')" 
                   class="action-btn deny" style="background:linear-gradient(90deg,#e53935,#8e0000); padding:10px 18px;">Logout</a></li>
        </ul>
    </nav>

    <!-- MESSAGES -->
    {% if messages %}
    <div class="admin-messages">
        {% for message in messages %}
            <div class="admin-message {{ message.tags }}">{{ message }}</div>
        {% endfor %}
    </div>
    {% endif %}

    <script>
    setTimeout(() => {
        document.querySelectorAll('.admin-message').forEach(msg => { msg.style.opacity = "0"; });
    }, 3000);
    </script>

    <!-- ===================== HEADER ===================== -->
    <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:20px;">
        <h1 class="section-title" style="margin:0;">Admin Dashboard</h1>
    </div>

    <!-- SUMMARY -->
    <div class="card summary-grid">
        <div class="summary-box"><h2>{{ total_bookings }}</h2><p>Total Bookings</p></div>
        <div class="summary-box"><h2>{{ approved_bookings }}</h2><p>Approved</p></div>
        <div class="summary-box"><h2>{{ pending_bookings.count }}</h2><p>Pending</p></div>
        <div class="summary-box"><h2>{{ cancelled_bookings }}</h2><p>Cancelled</p></div>
        <div class="summary-box"><h2>{{ total_users }}</h2><p>Total Users</p></div>
    </div>

    <div class="admin-grid">
        <!-- LEFT AREA -->
        <div>
            <!-- BOOKINGS TABLE -->
            <div class="card table-card">
                <h2 class="section-title">Booking Management</h2>
                <table>
                    <thead>
                        <tr>
                            <th>User</th>
                            <th>Service</th>
                            <th>Date</th>
                            <th>Status</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for booking in all_bookings %}
                        <tr>
                            <td>{{ booking.user.username }}</td>
                            <td>{{ booking.service_type }}</td>
                            <td>{{ booking.session_datetime|date:"F j, Y g:i A" }}</td>
                            <td>{{ booking.status }}</td>
                            <td>
                                <a href="#" class="action-btn approve" 
                                   onclick="showConfirmModal('Approve Booking','Approve booking for {{ booking.user.username }}?','{% url 'approve_booking' booking.id %}')">Approve</a>
                                <a href="#" class="action-btn deny" 
                                   onclick="showConfirmModal('Deny Booking','Deny booking for {{ booking.user.username }}?','{% url 'disapprove_booking' booking.id %}')">Deny</a>
                                <a href="{% url 'admin_update_booking' booking.id %}" class="action-btn edit">Edit</a>
                                <a href="{% url 'reschedule_booking' booking.id %}" class="action-btn resched">Re-Schedule</a>
                                <a href="#" class="action-btn deny delete-btn" 
                                   onclick="showConfirmModal('Delete Booking','Are you sure you want to delete this booking?','{% url 'admin_delete_booking' booking.id %}')">Delete</a>
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>

            <!-- CALENDAR -->
            <div class="card">
                <h2 class="section-title">Calendar View</h2>
                <div id="calendar" style="background:rgba(0,0,0,0.2); padding:20px; border-radius:15px;"></div>
            </div>

            <!-- USER LIST TABLE -->
            <div class="card table-card">
                <h2 class="section-title">User List</h2>
                <table>
                    <thead>
                        <tr>
                            <th>Username</th>
                            <th>Email</th>
                            <th>Date Joined</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for u in user_list %}
                        <tr>
                            <td>{{ u.username }}</td>
                            <td>{{ u.email }}</td>
                            <td>{{ u.date_joined|date:"F j, Y" }}</td>
                            <td>
                                <a href="#" class="action-btn user-del" 
                                   onclick="showConfirmModal('Delete User','Are you sure you want to delete user {{ u.username }}?','{% url 'admin_delete_user' u.id %}')">Delete User</a>
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>

            <!-- DELETED USERS RECORD -->
            <div class="card">
                <h2 class="section-title">Deleted Accounts Records</h2>
                <ul>
                    {% for deleted in deleted_users %}
                        <li>{{ deleted.timestamp }} — {{ deleted.username }} (Deleted by: {{ deleted.deleted_by }})</li>
                    {% empty %}
                        <li>No deleted user records.</li>
                    {% endfor %}
                </ul>
            </div>
        </div>

        <!-- RIGHT AREA -->
        <div>
            <div class="card">
                <h2 class="section-title">Notifications Center</h2>
                <ul>
                    {% for note in notifications %}
                        <li>{{ note.message }}</li>
                    {% empty %}<li>No notifications.</li>{% endfor %}
                </ul>
            </div>

            <div class="card">
                <h2 class="section-title">Audit / Activity Logs</h2>
                <ul>
                    {% for log in activity_logs %}
                        <li>{{ log.timestamp }} — {{ log.action }}</li>
                    {% empty %}<li>No logs available.</li>{% endfor %}
                </ul>
            </div>

            <div class="card">
                <h2 class="section-title">Reports & Analytics</h2>
                <p>Monthly reports, revenue, and customer statistics.</p>
            </div>
        </div>
    </div>
</div>

<!-- MODAL POPUP -->
<div id="bookingModal">
    <div class="modal-box">
        <span class="close-modal" onclick="closeModal()">&times;</span>
        <h3>Booking Details</h3>
        <p id="modalUser"></p>
        <p id="modalService"></p>
        <p id="modalDate"></p>
        <p id="modalStatus"></p>
        <a id="modalEditLink" class="action-btn edit" style="margin-top:10px; display:inline-block;">Edit Booking</a>
    </div>
</div>

<!-- UNIVERSAL CONFIRM MODAL -->
<div id="confirmActionModal" style="display:none; 
     position:fixed; top:0; left:0; width:100%; height:100%; 
     background:rgba(0,0,0,0.7); z-index:2000; 
     justify-content:center; align-items:center;">
    <div style="background:rgba(30,19,32,0.9); padding:25px; 
        width:400px; border-radius:15px; border:1px solid #c43b8d; color:white;">
        <span style="float:right; cursor:pointer; font-size:20px; color:#ccc;" 
              onclick="closeActionModal()">&times;</span>
        <h3 id="confirmActionTitle">Confirm Action</h3>
        <p id="confirmActionText" style="margin:20px 0; font-size:16px;"></p>
        <a href="#" id="confirmActionBtn" 
           style="background:linear-gradient(90deg,#e53935,#9a0007); 
                  padding:8px 14px; border-radius:10px; color:white; 
                  font-weight:600; text-decoration:none; margin-right:10px;">Confirm</a>
        <a href="#" style="background:linear-gradient(90deg,#757575,#333); 
                  padding:8px 14px; border-radius:10px; color:white; 
                  font-weight:600; text-decoration:none;" 
           onclick="closeActionModal()">Cancel</a>
    </div>
</div>

<script>
// ======================= CALENDAR ==========================
document.addEventListener('DOMContentLoaded', function() {
    var calendar = new FullCalendar.Calendar(document.getElementById('calendar'), {
        initialView: 'dayGridMonth',
        height: 650,
        editable: true,
        headerToolbar: { left: 'prev,next today', center: 'title', right: 'dayGridMonth,timeGridWeek,timeGridDay' },

        eventClick: function(info) {
            document.getElementById("modalUser").innerText = "User: " + info.event.extendedProps.user;
            document.getElementById("modalService").innerText = "Service: " + info.event.extendedProps.service;
            document.getElementById("modalDate").innerText = "Date: " + info.event.start.toLocaleString();
            document.getElementById("modalStatus").innerText = "Status: " + info.event.extendedProps.status;
            document.getElementById("modalEditLink").href = info.event.extendedProps.editUrl;
            document.getElementById("bookingModal").style.display = "flex";
        },

        events: [
            {% for b in all_bookings %}
            {
                title: "{{ b.service_type }}",
                start: "{{ b.session_datetime|date:'Y-m-d\\TH:i' }}",
                user: "{{ b.user.username }}",
                service: "{{ b.service_type }}",
                status: "{{ b.status }}",
                editUrl: "{% url 'admin_update_booking' b.id %}",
                classNames: [
                    {% if b.status == "Approved" %}"event-approved"{% endif %}
                    {% if b.status == "Pending" %}"event-pending"{% endif %}
                    {% if b.status == "Cancelled" %}"event-cancelled"{% endif %}
                    {% if b.status == "Denied" %}"event-denied"{% endif %}
                ]
            },
            {% endfor %}
        ],
    });
    calendar.render();
});

// MODAL CLOSE
function closeModal(){ document.getElementById("bookingModal").style.display = "none"; }

// ======================= UNIVERSAL CONFIRM MODAL ==========================
function showConfirmModal(actionType, text, url) {
    document.getElementById('confirmActionTitle').innerText = actionType;
    document.getElementById('confirmActionText').innerText = text;
    document.getElementById('confirmActionBtn').href = url;
    document.getElementById('confirmActionModal').style.display = 'flex';
}
function closeActionModal() {
    document.getElementById('confirmActionModal').style.display = 'none';
}
</script>
</body>
</html>
