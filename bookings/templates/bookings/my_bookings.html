{% extends 'base.html' %}
{% load static %}

{% block content %}
<div class="kb-bookings-wrapper">
    <h2 class="kb-title">My Bookings</h2>

    <!-- ALL USERS CAN CREATE BOOKINGS -->
    <a href="{% url 'create_booking' %}" class="kb-create-btn">+ Create Booking</a>

    <table class="kb-table">
        <thead>
            <tr>
                <th>Service</th>
                <th>Date</th>
                <th>Time</th>
                <th>Status</th>
                <th>Actions</th>
            </tr>
        </thead>
        <tbody>
            {% for booking in bookings %}
            <tr>
                <td>{{ booking.get_service_type_display }}</td>
                <td>{{ booking.session_datetime|date:"Y-m-d" }}</td>
                <td>{{ booking.session_datetime|time:"H:i" }}</td>
                <td>{{ booking.get_status_display }}</td>
                <td>
                    {% if booking.user == request.user %}
                        <a href="{% url 'update_booking' booking.pk %}" class="kb-edit">Edit</a>
                        {% if booking.status != 'cancelled' %}
                            <a href="{% url 'delete_booking' booking.pk %}" class="kb-delete">Delete</a>
                            <a href="{% url 'cancel_booking' booking.pk %}" class="kb-cancel">Cancel Booking</a>
                        {% else %}
                            <a href="javascript:void(0);" class="kb-remove" onclick="confirmRemove({{ booking.pk }})">Remove</a>
                        {% endif %}
                    {% endif %}
                </td>
            </tr>
            {% empty %}
            <tr>
                <td colspan="5" class="kb-empty">No bookings yet.</td>
            </tr>
            {% endfor %}
        </tbody>
    </table>
</div>

<!-- Confirmation Modal for Cancel/Delete -->
<div id="confirmModal" class="kb-modal">
    <div class="kb-modal-content">
        <p id="confirmMessage">Are you sure?</p>
        <div class="kb-modal-buttons">
            <button id="confirmYes">Yes</button>
            <button id="confirmNo">No</button>
        </div>
    </div>
</div>

<!-- Remove Modal -->
<div id="removeModal" class="kb-modal">
    <div class="kb-modal-content">
        <p>Are you sure you want to remove this booking?</p>
        <button id="removeYes">Yes</button>
        <button onclick="closeModal('removeModal')">No</button>
    </div>
</div>

<style>
:root{
    --bg:#0e0a12;
    --card:#1a121e;
    --accent:#c43b8d;
    --soft:#bca7c7;
}

.kb-bookings-wrapper{
    background:var(--card);
    padding:35px;
    margin:50px auto;
    width:90%;
    max-width:900px;
    border-radius:18px;
    box-shadow:0 8px 40px rgba(0,0,0,0.6);
    border:1px solid rgba(255,255,255,0.06);
    color:#fff;
}

.kb-title{
    font-family:'Great Vibes',cursive;
    font-size:48px;
    text-align:center;
    margin-top:0;
    margin-bottom:25px;
}

.kb-create-btn{
    display:inline-block;
    background:linear-gradient(90deg,#c43b8d,#8d2a62);
    color:white;
    padding:12px 20px;
    text-decoration:none;
    border-radius:10px;
    font-weight:600;
    box-shadow:0 10px 30px rgba(196,59,141,0.25);
    margin-bottom:20px;
}

.kb-create-btn:hover{
    opacity:0.9;
}

.kb-table{
    width:100%;
    border-collapse:collapse;
    color:white;
}

.kb-table th{
    padding:14px;
    background:rgba(255,255,255,0.05);
    font-weight:600;
    color:var(--accent);
}

.kb-table td{
    padding:14px;
    border-bottom:1px solid rgba(255,255,255,0.06);
    text-align:center;
}

.kb-table tr:hover{
    background:rgba(255,255,255,0.03);
}

.kb-edit{
    color:#6bb6ff;
    text-decoration:none;
    font-weight:600;
    margin:0 6px;
}

.kb-delete{
    color:#ff4d6d;
    text-decoration:none;
    font-weight:600;
    margin:0 6px;
}

.kb-cancel{
    color:#ff8c66;
    text-decoration:none;
    font-weight:600;
    margin:0 6px;
}

.kb-remove{
    color:#ffb366;
    text-decoration:none;
    font-weight:600;
    margin:0 6px;
}

.kb-cancel:hover,
.kb-delete:hover,
.kb-remove:hover{
    opacity:0.8;
}

.kb-empty{
    text-align:center;
    padding:20px;
    color:var(--soft);
}

/* Modal styles */
.kb-modal {
    display: none;
    position: fixed;
    z-index: 1000;
    left: 0;
    top: 0;
    width: 100%;
    height: 100%;
    background-color: rgba(0,0,0,0.6);
}

.kb-modal-content {
    background-color: var(--card);
    margin: 15% auto;
    padding: 30px;
    border-radius: 15px;
    width: 90%;
    max-width: 400px;
    text-align: center;
    border: 2px solid var(--accent);
    color: white;
}

.kb-modal-buttons button {
    padding: 10px 25px;
    margin: 10px;
    border: none;
    border-radius: 10px;
    font-weight: 600;
    cursor: pointer;
}

#confirmYes, #removeYes {
    background: linear-gradient(90deg,var(--accent),#8d2a62);
    color: white;
}

#confirmNo, .kb-modal-content button:nth-child(2) {
    background: #555;
    color: white;
}

.kb-modal-content button:hover {
    opacity:0.85;
    transform:scale(1.05);
}
</style>

<script>
let modal = document.getElementById('confirmModal');
let confirmMessage = document.getElementById('confirmMessage');
let confirmYes = document.getElementById('confirmYes');
let confirmNo = document.getElementById('confirmNo');
let targetLink = null;

// Cancel/Delete confirmation
document.querySelectorAll('.kb-cancel, .kb-delete').forEach(btn => {
    btn.addEventListener('click', function(e) {
        e.preventDefault();
        targetLink = this.href;
        confirmMessage.textContent = this.classList.contains('kb-cancel') ?
            'Are you sure you want to cancel this booking?' :
            'Are you sure you want to delete this booking?';
        modal.style.display = 'block';
    });
});

confirmYes.addEventListener('click', function() {
    window.location.href = targetLink;
});

confirmNo.addEventListener('click', function() {
    modal.style.display = 'none';
});

// Remove modal
let currentBookingId = null;

function confirmRemove(bookingId){
    currentBookingId = bookingId;
    document.getElementById('removeModal').style.display = 'block';
}

document.getElementById('removeYes').addEventListener('click', function(){
    window.location.href = '/bookings/delete/' + currentBookingId + '/';
});

function closeModal(modalId){
    document.getElementById(modalId).style.display = 'none';
}
</script>
{% endblock %}
